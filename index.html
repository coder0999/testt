<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>موقعي</title>
    <!-- Link to your manifest.json for PWA installation -->
    <link rel="manifest" href="manifest.json">
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Preconnect and DNS-prefetch for Google Auth domains to speed up initial connection -->
    <link rel="preconnect" href="https://accounts.google.com">
    <link rel="dns-prefetch" href="https://accounts.google.com">
    <link rel="preconnect" href="https://oauth.googleusercontent.com">
    <link rel="dns-prefetch" href="https://oauth.googleusercontent.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --active-bg: #e6f2ff; /* Light blue */
            --inactive-color: #999;
            --background-color: #ffffff;
            --text-color: #212529;
            --icon-active-fill: #007bff;
            --border-color: #e9ecef;
            --card-shadow: rgba(0, 0, 0, 0.08);
            --dropdown-bg: #ffffff;
            --dropdown-item-hover: #f1f3f5;

            /* New colors for exam review */
            --correct-answer-bg: #e6ffe6; /* Light green */
            --correct-answer-border: #28a745; /* Green */
            --incorrect-answer-bg: #ffe6e6; /* Light red */
            --incorrect-answer-border: #dc3545; /* Red */
        }

        body.dark-mode {
            --primary-color: #4da6ff;
            --secondary-color: #adb5bd;
            --active-bg: #1e3a5a;
            --inactive-color: #6c757d;
            --background-color: #121212;
            --text-color: #e9e9e9;
            --icon-active-fill: #4da6ff;
            --border-color: #2d2d2d;
            --card-shadow: rgba(0, 0, 0, 0.3);
            --dropdown-bg: #1e1e1e;
            --dropdown-item-hover: #2d2d2d;

            /* Dark mode colors for exam review */
            --correct-answer-bg: #1a4d2e; /* Darker green */
            --correct-answer-border: #4CAF50; /* Green */
            --incorrect-answer-bg: #4d1a1a; /* Darker red */
            --incorrect-answer-border: #f44336; /* Red */
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Cairo', sans-serif; /* Changed font to Cairo */
            background: var(--background-color); /* Default background */
            direction: rtl;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-color);
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-y: auto; /* Allow vertical scrolling for main content */
        }

        /* Hide browser scrollbar globally */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Set background for exam-taking-section to white */
        #exam-taking-section {
            background-color: var(--background-color); /* Changed to white */
            min-height: calc(100vh - 50px); /* Fill remaining height */
            padding-top: 2rem; /* Adjusted padding for content */
            padding-bottom: 2rem;
            box-sizing: border-box; /* Include padding in height calculation */
            max-width: 800px; /* Default max-width for larger screens */
            margin: 0 auto;
            text-align: right;
            width: 100%; /* Allow it to expand */
        }

        /* Ensure main content background is white when exam-taking-section is active */
        main {
            background-color: var(--background-color); /* Default background */
        }
        main:has(#exam-taking-section.active) {
            background-color: var(--background-color); /* Override main background to white when exam section is active */
        }


        #header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            padding: 0 1.25rem;
            background-color: var(--background-color);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        /* Updated header layout for RTL */
        .header-start-elements { /* New container for RTL right side */
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Reduced gap for closer elements */
        }

        .header-end-elements { /* New container for RTL left side */
            display: flex;
            align-items: center;
            gap: 1rem; /* Space between timer and more menu */
        }

        #back-arrow {
            display: none; /* Keep hidden by default */
            width: 24px;
            height: 24px;
            color: var(--primary-color);
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }

        #back-arrow:active {
            transform: scale(0.9);
        }

        .points-display {
            background-color: var(--active-bg);
            color: var(--primary-color);
            padding: 0.3rem 0.6rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.8rem;
            display: flex; /* Always flex for styling */
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease-in-out, background-color 0.3s ease;
            cursor: pointer; /* Indicate it's clickable */
            user-select: none; /* Prevent text selection on click */
        }

        .points-display:active {
            transform: scale(0.95); /* Add active state for visual feedback */
        }

        main {
            padding: 2rem 1.25rem;
            padding-bottom: 80px;
            text-align: center;
            min-height: calc(100vh - 70px - 50px);
            padding-top: calc(50px + 2rem);
            transition: background-color 0.3s ease;
            overflow-y: auto; /* Ensure main content can scroll */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Hide main content scrollbar if it appears */
        main::-webkit-scrollbar {
            display: none;
        }
        main {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        h1 {
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        section {
            display: none;
        }

        section.active {
            display: block;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 70px;
            background-color: var(--background-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--border-color);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            transition: background-color 0.3s ease, border-top-color 0.3s ease;
        }

        .bottom-nav button {
            background: none;
            border: none;
            color: var(--inactive-color);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            outline: none;
            padding: 6px 12px;
            position: relative;
            transition: all 0.1s ease;
        }

        .bottom-nav button:active {
            transform: scale(0.95);
        }

        .bottom-nav button.active {
            color: var(--primary-color);
        }

        .bottom-nav button .icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 0.5rem;
            transition: background-color 0.1s ease;
        }

        .bottom-nav button.active .icon-container {
            background-color: var(--active-bg);
        }

        .bottom-nav button svg {
            width: 24px;
            height: 24px;
        }

        .bottom-nav button span {
            margin-top: 4px;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            text-align: right;
        }

        .item-card {
            background-color: var(--background-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--card-shadow);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease;
        }
        .item-card:hover { transform: translateY(-5px); }

        .item-card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .item-card-info {
            font-size: 0.95rem;
            color: var(--text-color);
        }
        .start-button {
            background-color: #28a745;
            color: white;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1rem;
            align-self: flex-start;
        }

        .loading-indicator {
            text-align: center;
            color: var(--secondary-color);
            font-size: 1.1rem;
            padding: 2rem;
        }

        /* Custom Message Box */
        .custom-message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            z-index: 10000; /* Ensure it's on top */
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            font-size: 0.9rem;
            font-family: 'Cairo', sans-serif;
            text-align: right;
        }

        .custom-message-box.info { background-color: #e0f7fa; color: #006064; }
        .custom-message-box.success { background-color: #e8f5e9; color: #2e7d32; }
        .custom-message-box.error { background-color: #ffebee; color: #c62828; }

        /* Exam Taking Section Styles */
        #exam-taking-section {
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
            text-align: right;
        }

        #exam-taking-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .exam-timer-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            background-color: var(--active-bg);
            padding: 0.3rem 0.6rem;
            border-radius: 0.75rem;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .exam-timer-display.timer-warning {
            color: var(--incorrect-answer-border); /* Red color for warning */
            font-weight: 700; /* Make it bolder */
        }

        /* Exam Question Card styling */
        .exam-question-card {
            background-color: var(--background-color); /* Card background */
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--card-shadow);
            padding: 1.5rem; /* Consistent padding for all devices */
            margin-bottom: 1.5rem; /* Consistent margin for all devices */
            border: 1px solid var(--border-color);
        }

        .question-text {
            font-size: 1.05rem; /* Consistent font size for question text for all devices */
            color: var(--text-color);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-label {
            display: flex;
            align-items: center;
            background-color: var(--active-bg);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .option-radio {
            margin-left: 0.75rem; /* Space between radio and text */
            transform: scale(1.2); /* Slightly larger radio button */
            cursor: pointer;
            accent-color: var(--primary-color); /* Blue circle by default */
        }

        .option-label span {
            font-size: 0.95rem; /* Consistent font size for options for all devices */
            color: var(--text-color);
            flex-grow: 1; /* Allow text to take available space */
        }

        #submit-exam-button, .back-to-exams-button {
            background-color: #007bff; /* Primary blue */
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 2rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
            width: 100%;
            max-width: 300px; /* Limit width */
            margin-left: auto; /* Center button */
            margin-right: auto; /* Center button */
            display: block; /* Ensure it's a block element for centering */
        }
        
        .exam-summary-floating {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
        }

        .exam-review-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px dashed var(--border-color);
            text-align: right;
            flex-grow: 1;
        }
        
        /* Profile Section Specific Styles */
        #profile-content-area {
            background-color: var(--active-bg);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px var(--card-shadow);
        }
    </style>
</head>
<body class="">

    <header id="header-bar">
        <div class="header-start-elements">
            <svg id="back-arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="display: none;">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
            <div class="points-display" id="points-display"></div>
        </div>
        <div id="exam-timer" class="exam-timer-display"></div>
        <div class="header-end-elements">
            <div class="more-menu-container">
                <svg id="more-menu-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle>
                </svg>
                <div id="more-menu-dropdown" class="">
                    <a class="dropdown-item" onclick="showTab('profile'); toggleMoreMenu();">الملف الشخصي</a>
                    <a class="dropdown-item" onclick="showTab('settings'); toggleMoreMenu();">الإعدادات</a>
                    <a class="dropdown-item" onclick="showTab('notifications'); toggleMoreMenu();">الإشعارات</a>
                </div>
            </div>
        </div>
    </header>

    <main id="main">
        <section id="home" class="active">
             <h1>الصفحة الرئيسية</h1>
             <p>مرحباً بك في الموقع. تنقل بين الأقسام باستخدام الشريط السفلي.</p>
        </section>

        <section id="exams">
            <h1>الاختبارات</h1>
            <div id="exams-container" class="grid-container">
                <div class="loading-indicator">جاري تحميل الاختبارات...</div>
            </div>
        </section>
        
        <section id="exam-taking-section" class="">
            <h1 id="exam-taking-title"></h1>
            <div id="questions-display-container"></div>
            <button id="submit-exam-button" style="display: none;">تسليم</button>
        </section>

        <section id="reviews">
            <h1>التقييمات</h1>
            <div id="reviews-container" class="grid-container">
                <div class="loading-indicator">جاري تحميل التقييمات...</div>
            </div>
        </section>

        <!-- Other sections from original file, now with content containers -->
        <section id="profile">
            <h1 style="margin-bottom: 2rem;">الملف الشخصي</h1>
            <div id="profile-content-area">
                <!-- Profile content will be loaded here by JS -->
            </div>
        </section>
        <section id="store"><h1>المتجر</h1></section>
        <section id="summaries"><h1>الملخصات</h1></section>
        <section id="settings"><h1>الإعدادات</h1></section>
        <section id="notifications"><h1>الإشعارات</h1></section>
    </main>

    <nav class="bottom-nav" style="display: flex;">
        <button onclick="showTab('home')" class="active">
            <div class="icon-container">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1.58594 10.5453L10.9393 1.43968C11.5224 0.856576 12.4781 0.856576 13.0613 1.43968L22.4146 10.5453"/><path d="M16.5 4.62866V3.12866H20V7.84375"/><path d="M3 9.5V21.6552C3 22.0118 3.1724 22.3539 3.47928 22.6061C3.78616 22.8583 4.20237 23 4.63636 23H19.3636C19.7976 23 20.2138 22.8583 20.5207 22.6061C20.8276 22.3539 21 22.0118 21 21.6552V9.5"/><path d="M15 23V18C15 16.3431 13.6569 15 12 15V15C10.3431 15 9 16.3431 9 18V23"/></svg>
            </div>
            <span>الرئيسية</span>
        </button>
        <button onclick="showTab('exams')" class="">
            <div class="icon-container">
                <svg width="24" height="24" viewBox="0 0 294.023 294.023" fill="currentColor"><path d="M124.916,0.002 c-1.649,0.045-3.169,0.9-4.064,2.285l-14.49,21.736h-49.35c-2.761,0-5,2.239-5,5v50c0,2.761,2.239,5,5,5h50c2.761,0,5-2.239,5-5 V39.574l-10,15v19.449h-40v-40h37.682L85.631,55.117l-6.146-12.293c-1.205-2.485-4.196-3.523-6.681-2.318 c-2.485,1.205-3.523,4.196-2.318,6.681c0.018,0.036,0.035,0.072,0.054,0.108l10,20c1.235,2.47,4.238,3.472,6.709,2.237 c0.778-0.389,1.441-0.974,1.924-1.698l40-60c1.565-2.276,0.989-5.389-1.287-6.954C127.013,0.281,125.974-0.027,124.916,0.002 L124.916,0.002z M147.012,44.025c-2.761,0-5,2.239-5,5v10c0,2.761,2.239,5,5,5h90c2.761,0,5-2.239,5-5v-10c0-2.761-2.239-5-5-5 H147.012z M57.012,94.06c-2.761,0-5,2.239-5,5v50c0,2.761,2.239,5,5,5h50c2.761,0,5-2.239,5-5v-50c0-2.761-2.239-5-5-5H57.012z M62.012,104.06h40v40h-40V104.06z M147.012,114.023c-2.761,0-5,2.239-5,5v10c0,2.761,2.239,5,5,5h90c2.761,0,5-2.239,5-5v-10 c0-2.761-2.239-5-5-5H147.012z M57.012,164.023c-2.761,0-5,2.239-5,5v50c0,2.761,2.239,5,5,5h50c2.761,0,5-2.239,5-5v-50 c0-2.761-2.239-5-5-5H57.012z M62.012,174.023h40v40h-40V174.023z M147.012,184.058c-2.761,0-5,2.239-5,5v10c0,2.761,2.239,5,5,5h90 c2.761,0,5-2.239,5-5v-10c0-2.761-2.239-5-5-5H147.012z M57.012,234.023c-2.761,0-5,2.239-5,5v50c0,2.761,2.239,5,5,5h50 c2.761,0,5-2.239,5-5v-50c0-2.761-2.239-5-5-5L57.012,234.023L57.012,234.023z M62.012,244.023h40v40h-40V244.023z M147.012,254.023 c-2.761,0-5,2.239-5,5v10c0,2.761,2.239,5,5,5h90c2.761,0,5-2.239,5-5v-10c0-2.761-2.239-5-5-5H147.012z"/></svg>
            </div>
            <span>اختبارات</span>
        </button>
        <button onclick="showTab('reviews')" class="">
            <div class="icon-container">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9H21M9 15L11 17L15 13M7 3V5M17 3V5M6.2 21H17.8C19.4802 21 21 19.4802 21 17.8V8.2C21 6.51984 19.4802 5 17.8 5H6.2C4.51984 5 3 6.51984 3 8.2V17.8C3 19.4802 4.51984 21 6.2 21Z"/></svg>
            </div>
            <span>التقييمات</span>
        </button>
    </nav>

    <div id="custom-message-box" class="custom-message-box"></div>

    <!-- === START FIREBASE INTEGRATION === -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration from the prompt
        const firebaseConfig = {
            apiKey: "AIzaSyCzXajGeExTVfcMJ9L3fJjRl9TSu0apRZY",
            authDomain: "tanya-thanawey.firebaseapp.com",
            projectId: "tanya-thanawey",
            storageBucket: "tanya-thanawey.firebasestorage.app",
            messagingSenderId: "963147710003",
            appId: "1:963147710003:web:355267be9545ee8f1fad46",
            measurementId: "G-QJ6TK546YK"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Use a consistent App ID for Firestore paths
        const appId = "tanya-thanawey";

        // References to Firestore collections
        const examsCollectionRef = collection(db, `artifacts/${appId}/public/data/exams`);
        const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);
        
        // Global variables
        let currentExamData = null;
        let examTimerInterval = null;
        let userAnswers = [];
        let currentUserId = null;
        let currentPoints = 0;
        let completedExamsSet = new Set();

        // UI Elements
        const examsContainer = document.getElementById('exams-container');
        const reviewsContainer = document.getElementById('reviews-container');
        const examTakingSection = document.getElementById('exam-taking-section');
        const examTitleElement = document.getElementById('exam-taking-title');
        const questionsDisplayContainer = document.getElementById('questions-display-container');
        const submitExamButton = document.getElementById('submit-exam-button');
        const examTimerElement = document.getElementById('exam-timer');
        const backArrow = document.getElementById('back-arrow');
        const profileContentArea = document.getElementById('profile-content-area');
        const pointsDisplayElement = document.getElementById('points-display');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;
            updateProfileUI(user);
            if (user) {
                await saveUserProfile(user);
                await fetchUserPoints();
                await fetchCompletedExams();
            } else {
                currentPoints = 0;
                completedExamsSet.clear();
                updatePointsDisplay();
                loadExams(); // Reload exams to show all
            }
        });

        const updateProfileUI = (user) => {
            if (!profileContentArea) return;
            profileContentArea.innerHTML = '';
            if (user) {
                const userPhoto = user.photoURL ? `<img src="${user.photoURL}" alt="صورة الملف الشخصي" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 1.5rem; border: 3px solid var(--primary-color);">` : '';
                profileContentArea.innerHTML = `
                    ${userPhoto}
                    <h2 style="color: var(--primary-color); font-size: 1.8rem; margin-bottom: 0.5rem;">أهلاً بك، ${user.displayName || 'مستخدم'}!</h2>
                    <p style="color: var(--secondary-color); font-size: 0.95rem; margin-bottom: 2rem;">${user.email || ''}</p>
                    <button onclick="window.signOutUser()" style="padding: 12px 24px; background-color: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">تسجيل الخروج</button>
                `;
            } else {
                profileContentArea.innerHTML = `
                    <p style="color: var(--text-color); font-size: 1.1rem; margin-bottom: 2rem;">سجل الدخول لحفظ تقدمك ونقاطك.</p>
                    <button onclick="window.signInWithGoogle()" style="padding: 12px 24px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer;">تسجيل الدخول باستخدام جوجل</button>
                `;
            }
        };
        
        window.signInWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Error during Google Sign-in:', error);
            }
        };

        window.signOutUser = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error during sign out:', error);
            }
        };

        const saveUserProfile = async (user) => {
            if (!user) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'data');
            const profileData = {
                uid: user.uid,
                displayName: user.displayName || null,
                email: user.email || null,
                photoURL: user.photoURL || null,
                lastLogin: serverTimestamp()
            };
            await setDoc(userDocRef, profileData, { merge: true });
        };
        
        // --- POINTS SYSTEM ---
        const fetchUserPoints = async () => {
            if (!currentUserId) return;
            const pointsDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/points`, 'data');
            const docSnap = await getDoc(pointsDocRef);
            if (docSnap.exists()) {
                currentPoints = docSnap.data().value || 0;
            } else {
                await setDoc(pointsDocRef, { value: 0 });
                currentPoints = 0;
            }
            updatePointsDisplay();
        };

        const updateUserPoints = async (pointsToAdd) => {
            if (!currentUserId) return;
            const newTotalPoints = currentPoints + pointsToAdd;
            const pointsDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/points`, 'data');
            await setDoc(pointsDocRef, { value: newTotalPoints }, { merge: true });
            currentPoints = newTotalPoints;
            updatePointsDisplay();
        };

        const updatePointsDisplay = () => {
            if (pointsDisplayElement) {
                pointsDisplayElement.textContent = `${currentPoints} نقاط`;
            }
        };

        // --- UI & Navigation ---
        window.showTab = (id) => {
            document.querySelectorAll('main > section').forEach(sec => sec.classList.remove('active'));
            const sectionToShow = document.getElementById(id);
            if(sectionToShow) sectionToShow.classList.add('active');
            document.querySelectorAll('.bottom-nav button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('onclick') === `showTab('${id}')`);
            });
            const isChildPage = !['home', 'exams', 'reviews'].includes(id);
            document.querySelector('.bottom-nav').style.display = isChildPage ? 'none' : 'flex';
            backArrow.style.display = isChildPage ? 'block' : 'none';
            examTimerElement.style.display = id === 'exam-taking-section' ? 'flex' : 'none';
        };

        backArrow.addEventListener('click', () => {
            if (examTakingSection.classList.contains('active')) {
                showTab('exams');
            } else {
                showTab('home');
            }
        });
        
        window.toggleMoreMenu = () => document.getElementById('more-menu-dropdown').classList.toggle('active');

        // --- Data Loading ---
        const fetchCompletedExams = async () => {
             if (!currentUserId) return;
             const completedExamsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/completedExams`);
             onSnapshot(completedExamsRef, (snapshot) => {
                 completedExamsSet.clear();
                 snapshot.forEach(doc => completedExamsSet.add(doc.id));
                 loadExams(); // Refresh exam list after fetching completed ones
             });
        }

        const loadExams = () => {
            const q = query(examsCollectionRef, orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                examsContainer.innerHTML = '';
                if (snapshot.empty) {
                    examsContainer.innerHTML = '<p class="loading-indicator">لا توجد اختبارات متاحة حاليًا.</p>';
                    return;
                }
                snapshot.docs.forEach((doc) => {
                    // Only show exams that are not completed by the user
                    if (!completedExamsSet.has(doc.id)) {
                        const exam = doc.data();
                        const card = document.createElement('div');
                        card.className = 'item-card';
                        card.innerHTML = `
                            <h3 class="item-card-title">${exam.name}</h3>
                            <p class="item-card-info">المدة: ${exam.duration} دقيقة</p>
                            <p class="item-card-info">عدد الأسئلة: ${exam.numQuestions}</p>
                            <button class="start-button" data-exam-id="${doc.id}">ابدأ الاختبار</button>
                        `;
                        examsContainer.appendChild(card);
                    }
                });
                if (examsContainer.children.length === 0) {
                     examsContainer.innerHTML = '<p class="loading-indicator">لقد أكملت جميع الاختبارات المتاحة!</p>';
                }
            });
        };

        const loadReviews = () => {
            const q = query(reviewsCollectionRef, orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                reviewsContainer.innerHTML = '';
                if (snapshot.empty) {
                    reviewsContainer.innerHTML = '<p class="loading-indicator">لا توجد تقييمات متاحة حاليًا.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const review = doc.data();
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `
                        <h3 class="item-card-title">${review.text}</h3>
                        <button class="start-button">افتح الرابط</button>
                    `;
                    card.querySelector('.start-button').addEventListener('click', () => window.open(review.link, '_blank'));
                    reviewsContainer.appendChild(card);
                });
            });
        };

        // --- Exam Logic ---
        const startExam = async (examId) => {
            if (!currentUserId) {
                alert("الرجاء تسجيل الدخول أولاً لبدء الاختبار.");
                showTab('profile');
                return;
            }
            showTab('exam-taking-section');
            examTitleElement.textContent = 'جاري تحميل الامتحان...';
            questionsDisplayContainer.innerHTML = '<div class="loading-indicator">جاري تحميل الأسئلة...</div>';
            submitExamButton.style.display = 'none';

            const examDocRef = doc(examsCollectionRef, examId);
            const docSnap = await getDoc(examDocRef);

            if (docSnap.exists()) {
                currentExamData = { id: docSnap.id, ...docSnap.data() };
                examTitleElement.textContent = `اختبار: ${currentExamData.name}`;
                renderExamQuestions(currentExamData.questions);
                startTimer(currentExamData.duration);
                submitExamButton.style.display = 'block';
            } else {
                examTitleElement.textContent = 'الامتحان غير موجود.';
            }
        };
        
        const renderExamQuestions = (questions) => {
            questionsDisplayContainer.innerHTML = '';
            userAnswers = new Array(questions.length).fill(null);
            questions.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'exam-question-card';
                questionDiv.innerHTML = `
                    <p class="question-text"><strong>السؤال ${qIndex + 1}:</strong> ${q.questionText}</p>
                    <div class="options-container">
                        ${q.options.map((option, optIndex) => `
                            <label class="option-label">
                                <input type="radio" name="question-${qIndex}" value="${optIndex}" class="option-radio">
                                <span>${option}</span>
                            </label>
                        `).join('')}
                    </div>`;
                questionsDisplayContainer.appendChild(questionDiv);
            });
        };
        
        questionsDisplayContainer.addEventListener('change', e => {
            if(e.target.type === 'radio') {
                const qIndex = parseInt(e.target.name.split('-')[1]);
                userAnswers[qIndex] = parseInt(e.target.value);
            }
        });

        const startTimer = (durationMinutes) => {
            let remainingTime = durationMinutes * 60;
            if (examTimerInterval) clearInterval(examTimerInterval);
            examTimerInterval = setInterval(() => {
                if (remainingTime <= 0) {
                    clearInterval(examTimerInterval);
                    examTimerElement.textContent = 'انتهى الوقت!';
                    submitExam();
                    return;
                }
                remainingTime--;
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                examTimerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if(remainingTime < 60) examTimerElement.classList.add('timer-warning');
            }, 1000);
        };

        const submitExam = async () => {
            if (examTimerInterval) clearInterval(examTimerInterval);
            
            let correctAnswersCount = 0;
            let pointsEarned = 0;
            currentExamData.questions.forEach((q, qIndex) => {
                if (userAnswers[qIndex] === q.correctOptionIndex) {
                    correctAnswersCount++;
                    pointsEarned += (q.points || 10); // Add points for correct answer
                }
            });

            if (currentUserId) {
                await updateUserPoints(pointsEarned);
                // Mark exam as completed
                const completedExamDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/completedExams`, currentExamData.id);
                await setDoc(completedExamDocRef, { completedAt: serverTimestamp(), score: correctAnswersCount });
            }
            
            displayExamResults(correctAnswersCount, pointsEarned);
            submitExamButton.style.display = 'none';
        };
        
        const displayExamResults = (score, points) => {
            const totalQuestions = currentExamData.questions.length;
            const percentageScore = (totalQuestions > 0) ? ((score / totalQuestions) * 100).toFixed(1) : 0;

            questionsDisplayContainer.innerHTML = `
                <div class="exam-summary-floating">
                    <h2>نتيجتك:</h2>
                    <p>أجبت على ${score} سؤال صحيح من أصل ${totalQuestions}.</p>
                    <p>النسبة المئوية: ${percentageScore}%</p>
                    <p>النقاط المكتسبة: ${points} نقطة</p>
                </div>
                <div class="exam-review-container"><h3>مراجعة الامتحان:</h3></div>
                <button class="back-to-exams-button" onclick="showTab('exams')">العودة للاختبارات</button>
            `;
            
            const reviewContainer = questionsDisplayContainer.querySelector('.exam-review-container');
            currentExamData.questions.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'exam-question-card review-mode';
                questionDiv.innerHTML = `
                    <p class="question-text"><strong>السؤال ${qIndex + 1}:</strong> ${q.questionText}</p>
                    <div class="options-container">
                        ${q.options.map((option, optIndex) => {
                            let labelClass = 'option-label';
                            if (optIndex === q.correctOptionIndex) labelClass += ' correct-answer';
                            if (userAnswers[qIndex] === optIndex && optIndex !== q.correctOptionIndex) labelClass += ' user-incorrect-answer';
                            return `<label class="${labelClass}"><input type="radio" name="review-q-${qIndex}" ${userAnswers[qIndex] === optIndex ? 'checked' : ''} disabled><span>${option}</span></label>`;
                        }).join('')}
                    </div>`;
                reviewContainer.appendChild(questionDiv);
            });
        };

        // --- Event Delegation ---
        document.getElementById('exams-container').addEventListener('click', (e) => {
            if (e.target.matches('.start-button')) {
                const examId = e.target.dataset.examId;
                startExam(examId);
            }
        });

        // --- Initial Load ---
        showTab('home');
        loadExams();
        loadReviews();

    </script>
</body>
</html>
