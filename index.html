<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة الامتحانات</title>
    <!-- تضمين Tailwind CSS و Font Awesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }
        .nav-icon {
            font-size: 1.5rem;
        }
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .custom-alert-box {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            width: 40px;
            height: 40px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- المحتوى الرئيسي للتطبيق -->
    <div class="flex-grow flex flex-col p-4 mb-20">

        <!-- صفحة الامتحانات (عرض البطاقات) -->
        <div id="exams-page" class="container mx-auto p-4 flex-grow">
            <h1 class="text-4xl font-bold text-center text-gray-800 my-8">الامتحانات المتاحة</h1>
            <div id="exams-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- سيتم عرض بطاقات الامتحانات هنا بواسطة JavaScript -->
                <p id="no-exams-message" class="col-span-full text-center text-gray-500 hidden">لا توجد امتحانات متاحة حالياً.</p>
            </div>
        </div>

        <!-- صفحة التقييمات -->
        <div id="evaluations-page" class="hidden container mx-auto p-4 flex-grow">
            <h1 class="text-4xl font-bold text-center text-gray-800 my-8">المواد الدراسية</h1>
            <div id="subjects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Subject cards will be loaded here -->
            </div>
        </div>
        
        <!-- صفحة الامتحان (لعرض الأسئلة) -->
        <div id="exam-view" class="hidden container mx-auto p-4 max-w-3xl flex-grow">
            <h2 id="exam-title" class="text-3xl font-bold text-gray-800 text-center mb-6"></h2>
            <div id="questions-container" class="space-y-6">
                <!-- سيتم عرض أسئلة الامتحان هنا -->
            </div>
            <div class="flex justify-between mt-8">
                <button id="submit-exam-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    إرسال الإجابات
                </button>
                <button id="back-to-exams-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    العودة
                </button>
            </div>
        </div>

        <!-- صفحة عرض النتائج (جديدة) -->
        <div id="results-page" class="hidden container mx-auto p-4 max-w-3xl flex-grow">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">نتائج الامتحان</h2>
            <div id="results-container" class="space-y-6">
                <!-- سيتم عرض النتائج هنا بواسطة JavaScript -->
            </div>
            <div class="flex justify-center mt-8">
                <button id="back-from-results-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    العودة إلى الامتحانات
                </button>
            </div>
        </div>

    </div>

    <!-- شريط التنقل السفلي -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 w-full bg-white shadow-2xl z-10">
        <div class="flex justify-around items-center h-16">
            <button id="nav-exams-btn" class="flex flex-col items-center text-blue-600 focus:outline-none p-2">
                <i class="fas fa-clipboard-list nav-icon"></i>
                <span class="text-xs mt-1 font-bold">الامتحانات</span>
            </button>
            <button id="nav-evaluations-btn" class="flex flex-col items-center text-gray-500 hover:text-blue-600 focus:outline-none p-2">
                <i class="fas fa-chart-bar nav-icon"></i>
                <span class="text-xs mt-1">التقييمات</span>
            </button>
        </div>
    </nav>

    <!-- مربع حواري مخصص لعرض رسائل النظام -->
    <div id="custom-alert" class="custom-alert-overlay hidden">
        <div class="custom-alert-box">
            <p id="custom-alert-message" class="text-lg text-gray-700"></p>
            <button id="custom-alert-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">موافق</button>
        </div>
    </div>

    <!-- شاشة التحميل -->
    <div id="loading-spinner" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <script type="module">
        // استيراد وظائف Firebase اللازمة
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCzXajGeExTVfcMJ9L3fJjRl9TSu0apRZY",
            authDomain: "tanya-thanawey.firebaseapp.com",
            projectId: "tanya-thanawey",
            storageBucket: "tanya-thanawey.firebasestorage.app",
            messagingSenderId: "963147710003",
            appId: "1:963147710003:web:355267be9545ee8f1fad46"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // المتغيرات العالمية للوصول إليها
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tanya-thanawey';
        let unsubscribeFromExams = null; // للاشتراك في التحديثات
        let currentExam = null; // لتخزين الامتحان الحالي
        
        // الحصول على عناصر DOM
        const examsPage = document.getElementById('exams-page');
        const evaluationsPage = document.getElementById('evaluations-page');
        const examView = document.getElementById('exam-view');
        const resultsPage = document.getElementById('results-page'); // العنصر الجديد لصفحة النتائج
        
        const examsList = document.getElementById('exams-list');
        const noExamsMessage = document.getElementById('no-exams-message');
        const questionsContainer = document.getElementById('questions-container');
        const examTitle = document.getElementById('exam-title');
        const backToExamsBtn = document.getElementById('back-to-exams-btn');
        const submitExamBtn = document.getElementById('submit-exam-btn');

        const resultsContainer = document.getElementById('results-container'); // حاوية النتائج
        const backFromResultsBtn = document.getElementById('back-from-results-btn'); // زر العودة من النتائج

        const navExamsBtn = document.getElementById('nav-exams-btn');
        const navEvaluationsBtn = document.getElementById('nav-evaluations-btn');

        const customAlertOverlay = document.getElementById('custom-alert');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok');
        const loadingSpinner = document.getElementById('loading-spinner');

        // دالة لعرض مربع حواري مخصص
        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertOverlay.classList.remove('hidden');
        }

        // دالة لإغلاق مربع حواري مخصص
        customAlertOkBtn.addEventListener('click', () => {
            customAlertOverlay.classList.add('hidden');
        });

        // *** NEW FUNCTION TO RENDER SUBJECTS ***
        async function renderSubjects() {
            const subjectsContainer = document.getElementById('subjects-container');
            if (!subjectsContainer) return;

            subjectsContainer.innerHTML = `<p class="text-center text-gray-600 col-span-full">Loading subjects...</p>`;
            
            try {
                const subjectsCollectionRef = collection(db, `artifacts/${appId}/public/data/subjects`);
                const querySnapshot = await getDocs(subjectsCollectionRef);
                
                if (querySnapshot.empty) {
                    subjectsContainer.innerHTML = `<p class="text-center text-gray-600 col-span-full">No subjects found.</p>`;
                    return;
                }

                subjectsContainer.innerHTML = ''; // Clear loading message
                querySnapshot.forEach((doc) => {
                    const subject = doc.data();
                    const subjectCard = document.createElement('a');
                    subjectCard.href = subject.link || '#';
                    subjectCard.target = '_blank';
                    subjectCard.rel = 'noopener noreferrer';
                    subjectCard.className = 'bg-white rounded-xl shadow-md p-6 flex flex-col items-center justify-center space-y-4 hover:shadow-lg transition-shadow cursor-pointer no-underline';
                    
                    subjectCard.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 text-center">${subject.name}</h3>
                        <div class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-download"></i>
                            <span>تنزيل</span>
                        </div>
                    `;
                    subjectsContainer.appendChild(subjectCard);
                });

            } catch (error) {
                console.error("Error rendering subjects:", error);
                subjectsContainer.innerHTML = `<p class="text-center text-red-500 col-span-full">Error loading subjects.</p>`;
            }
        }

        // دالة لتبديل عرض الصفحات
        function showPage(pageId) {
            // إخفاء جميع الصفحات أولاً
            examsPage.classList.add('hidden');
            evaluationsPage.classList.add('hidden');
            examView.classList.add('hidden');
            resultsPage.classList.add('hidden');
            
            // إظهار الصفحة المطلوبة
            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.remove('hidden');

            // تحديث أزرار التنقل
            navExamsBtn.classList.remove('text-blue-600', 'font-bold');
            navExamsBtn.classList.add('text-gray-500');
            navEvaluationsBtn.classList.remove('text-blue-600', 'font-bold');
            navEvaluationsBtn.classList.add('text-gray-500');
            
            const activeButton = document.querySelector(`#nav-${pageId.replace('-page', '')}-btn`);
            if (activeButton) {
                activeButton.classList.remove('text-gray-500');
                activeButton.classList.add('text-blue-600', 'font-bold');
            }

            if (pageId === 'evaluations-page') {
                renderSubjects();
            }
        }

        // مستمعو أحداث التنقل
        navExamsBtn.addEventListener('click', () => showPage('exams-page'));
        navEvaluationsBtn.addEventListener('click', () => showPage('evaluations-page'));

        // وظيفة لعرض بطاقات الامتحانات
        function renderExamCards(exams) {
            examsList.innerHTML = '';
            if (exams.length === 0) {
                noExamsMessage.classList.remove('hidden');
            } else {
                noExamsMessage.classList.add('hidden');
                exams.forEach(exam => {
                    const examCard = document.createElement('div');
                    examCard.className = 'bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition-shadow cursor-pointer flex flex-col justify-between';
                    examCard.dataset.id = exam.id;
                    const examDate = new Date(exam.data.createdAt).toLocaleString();
                    examCard.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">امتحان جديد</h3>
                            <p class="text-gray-600 text-sm">تم الإنشاء: ${examDate}</p>
                        </div>
                    `;
                    examCard.addEventListener('click', () => startExam(exam));
                    examsList.appendChild(examCard);
                });
            }
        }

        // وظيفة لعرض صفحة الامتحان
        function startExam(exam) {
            currentExam = exam; // حفظ الامتحان الحالي
            showPage('exam-view');
            examTitle.textContent = `امتحان تم إنشاؤه في: ${new Date(exam.data.createdAt).toLocaleString()}`;
            questionsContainer.innerHTML = '';

            exam.data.questions.forEach((question, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'p-6 bg-white rounded-lg shadow-md';
                questionElement.innerHTML = `
                    <p class="font-bold text-lg text-gray-800 mb-4">سؤال ${index + 1}: ${question.text}</p>
                    <div class="space-y-2">
                        ${question.options.map((option, optIndex) => `
                            <div class="flex items-center">
                                <input type="radio" name="question-${index}" value="${option.text}" class="form-radio text-blue-600 focus:ring-blue-500 ml-2">
                                <label class="text-gray-700">${option.text}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionElement);
            });
        }
        
        // وظيفة جديدة لعرض صفحة النتائج
        function showResultsPage(exam, userAnswers) {
            showPage('results-page');
            resultsContainer.innerHTML = '';
            
            exam.data.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                // الافتراض هنا أن الخيار الصحيح هو الأول في المصفوفة
                // بناءً على الكود في الملف 522.txt
                const correctAnswer = question.options[0].text;
                const isCorrect = userAnswer === correctAnswer;
                
                const resultElement = document.createElement('div');
                resultElement.className = 'p-6 bg-white rounded-lg shadow-inner border border-gray-200';
                
                let optionsHtml = question.options.map(option => {
                    let optionClass = '';
                    if (option.text === userAnswer) {
                        optionClass = isCorrect ? 'text-green-600' : 'text-red-600';
                    }
                    return `<div class="text-gray-700 ${optionClass}">${option.text}</div>`;
                }).join('');
                
                resultElement.innerHTML = `
                    <p class="font-bold text-lg text-gray-800 mb-4">سؤال ${index + 1}: ${question.text}</p>
                    <div class="space-y-2">
                        ${optionsHtml}
                    </div>
                `;
                resultsContainer.appendChild(resultElement);
            });
        }
        
        // مستمع لزر "العودة"
        backToExamsBtn.addEventListener('click', () => showPage('exams-page'));

        // مستمع لزر "العودة من صفحة النتائج"
        backFromResultsBtn.addEventListener('click', () => showPage('exams-page'));

        // مستمع لزر "إرسال الإجابات"
        submitExamBtn.addEventListener('click', () => {
            const userAnswers = [];
            currentExam.data.questions.forEach((question, index) => {
                const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                if (selectedOption) {
                    userAnswers.push(selectedOption.value);
                } else {
                    userAnswers.push(null); // إذا لم يتم اختيار أي خيار
                }
            });

            // عرض صفحة النتائج
            showResultsPage(currentExam, userAnswers);
        });
        
        // --- المصادقة وتحميل البيانات ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // إذا لم يتم تسجيل الدخول، لا نفعل شيئًا.
                // يمكن إضافة واجهة لتسجيل الدخول هنا لاحقًا إذا لزم الأمر.
                showCustomAlert('الرجاء تسجيل الدخول لعرض الامتحانات.');
            }
        });

        // بمجرد تسجيل الدخول، نبدأ في تحميل البيانات
        auth.onAuthStateChanged(user => {
            if (user && !unsubscribeFromExams) {
                loadingSpinner.classList.remove('hidden');
                const examsCollection = collection(db, `artifacts/${appId}/public/data/exams`);
                
                // الاستماع للتحديثات في الوقت الفعلي
                unsubscribeFromExams = onSnapshot(examsCollection, (snapshot) => {
                    const exams = [];
                    snapshot.forEach(doc => {
                        exams.push({
                            id: doc.id,
                            data: doc.data()
                        });
                    });
                    renderExamCards(exams);
                    loadingSpinner.classList.add('hidden');
                }, (error) => {
                    console.error("خطأ في جلب الامتحانات:", error);
                    showCustomAlert('فشل في جلب قائمة الامتحانات.');
                    loadingSpinner.classList.add('hidden');
                });
            } else if (!user && unsubscribeFromExams) {
                // إلغاء الاشتراك عند تسجيل الخروج
                unsubscribeFromExams();
                unsubscribeFromExams = null;
                examsList.innerHTML = '';
            }
        });
        
        // عرض صفحة الامتحانات بشكل افتراضي عند تحميل الصفحة
        showPage('exams-page');

    </script>
</body>
</html>
